rule all:
    output: expand("{accession}/{accession}.all", accession=config["accessions"] if type(config["accessions"]) == list else config["accessions"].split(","))
    input: expand("{accession}/cirit.fasta", accession=config["accessions"] if type(config["accessions"]) == list else config["accessions"].split(","))

rule download_sra:
    output: 
        temp("{accession}/{accession}_1.fastq"),
        temp("{accession}/{accession}_2.fastq")
    resources: 
        cpus=6
    envmodules:
        "sratoolkit/2.9.6",
    shell: 
        "fasterq-dump {wildcards.accession} -O {wildcards.accession} -e {resources.cpus}"

rule fastp:
    input: 
        r1 = "{accession}/{accession}_1.fastq",
        r2 = "{accession}/{accession}_2.fastq"
    output: 
        r1 = "{accession}/{accession}_1.fastp.fastq.gz",
        r2 = "{accession}/{accession}_2.fastp.fastq.gz"
    resources:
         # If you want to change the numer of CPUs, make sure pass one fewer thread to fastp
         # It uses the worker thread count in addition to one extra as the "main" thread
        cpus = 17,
    envmodules:
        "fastp/0.20.1"
    shell: 
        "fastp -i {input.r1} -I {input.r2} -o {output.r1} -O {output.r2} "
        "--detect_adapter_for_pe --thread 16 "
        "-h {wildcards.accession}/{wildcards.accession}.fastp.html -j {wildcards.accession}/{wildcards.accession}.fastp.json -z 9"

rule rnaspades:
    input: 
        r1 = "{accession}/{accession}_1.fastp.fastq.gz",
        r2 = "{accession}/{accession}_2.fastp.fastq.gz"
    output: "{accession}/rnaspades/transcripts.fasta"
    resources:
        cpus = 32,
        mem_mb = 50000, # the max memory for SPAdes defaults to 250 G but we never even get close
        time_min = 240
    envmodules:
        "spades/3.14.1"
    shell: "export OMP_NUM_THREADS={resources.cpus} && rnaspades.py -1 {input.r1} -2 {input.r2} -o {wildcards.accession}/rnaspades --threads {resources.cpus}"

rule cirit:
    input: "{accession}/rnaspades/transcripts.fasta"
    output: "{accession}/cirit.fasta"
    resources:
        time_min = 5
    envmodules:
        "java/12.0.1"
    shell: "java -jar ~/Cirit-1.0.jar -i {input} -o {output}"